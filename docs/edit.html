<!DOCTYPE HTML PUBLIC "-//W3C/DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Mole Mole(Construction Mode)</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-web-app-capable" content="yes"/>

<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<style type="text/css">
html, body{
  text-align: center;
  background-color: #fafafa;
  font-size: 20px;
  color: #333;
}
#mycanvas{
  border: 1px solid #333;
}
</style>
<script>
/*
| # | 意味 |
|---|----------------|
| 0 | なにもない空間 |
| 1 | ドア（ゴール） |
| 2 | はしご　　　　 |
| 3 | 土　　　　　　 |
| 4 | 石　　　　　　 |
| 5 | いも　　　　　 |
*/
var board = [
    [ 0, 0, 0, 1 ],
    [ 2, 0, 0, 2 ],
    [ 2, 0, 0, 2 ],
    [ 2, 5, 5, 2 ]
];
var mx = 0;
var my = 0;
var W = 4;
var H = 4;
var imgs = new Array(7);
$(function(){
  //. リサイズ時に Canvas サイズを変更する
  $(window).on( 'load resize', function(){
    resized();
  });

  for( var i = 0; i < imgs.length; i ++ ){
    imgs[i] = new Image();
    switch( i ){
    case 0:
      imgs[i].src = '';
      break;
    case 1:
      //. いろいろな状態のドアのイラスト https://www.irasutoya.com/2016/07/blog-post_832.html
      imgs[i].src = '//2.bp.blogspot.com/-6noe-4G5FNU/V2ubhr0UDKI/AAAAAAAA7pY/nHp2zGXHshkiwzUxYa5RQVf-pcwn31GSACLcB/s800/door_half_open.png';
      break;
    case 2:
      //. 木のはしごのイラスト https://www.irasutoya.com/2018/12/blog-post_0.html
      imgs[i].src = '//4.bp.blogspot.com/-KXZX2Dzgxp8/W959SKWDBWI/AAAAAAABPzg/rNCg1_jM-H8tCzVaE44KKr7fFILDu8PcgCLcBGAs/s400/hashigo_wood.png';
      break;
    case 3:
      //. デジタルデータ風の背景素材（緑） https://www.irasutoya.com/2017/04/blog-post_62.html
      imgs[i].src = '//3.bp.blogspot.com/-YtrWSqttYsQ/WM9XglY6dtI/AAAAAAABCrE/FKxvLU_Dllkg7PN1RV8xSys-7M86MS1vwCLcB/s550/bg_digital_pattern_green.jpg';
      break;
    case 4:
      //. 石垣のイラスト（背景素材） https://www.irasutoya.com/2018/07/blog-post_333.html
      imgs[i].src = '//2.bp.blogspot.com/-2GHF5yihAe4/WzC9Vv0X12I/AAAAAAABM3w/-VUqC6sA9oUNTcUdmrifKEL98J2raf_4QCLcBGAs/s600/bg_pattern_ishigaki.jpg';
      break;
    case 5:
      //. スネークフルーツのイラスト https://www.irasutoya.com/2015/08/blog-post_972.html
      imgs[i].src = '//3.bp.blogspot.com/-WXAP4rf3rBI/VcMlRoi4hhI/AAAAAAAAwYk/Ed6UHivguW4/s400/fruit_saraku.png';
      break;
    case 6:
      //. もぐらのイラスト https://www.irasutoya.com/2013/01/blog-post_3363.html
      imgs[i].src = '//3.bp.blogspot.com/-ovqmiEaRorA/UOKDDWaU39I/AAAAAAAAKLQ/m2iyIQ3yWuc/s1600/animal_mogura.png';
      break;
    }
  }

  if( location.search && location.search.length > 1 ){
    var t = location.search.substr( 1 );
    if( t ){
      var filename = "";
      var t = t.split( '&' );
      t.forEach( function( tmp ){
        var param = tmp.split( '=' );
        if( param.length == 2 ){
          if( param[0] == 'board' ){
            try{
              var _board = JSON.parse( param[1] );
              if( _board.length && _board[0].length && typeof _board[0][0] == 'number' ){
                board = JSON.parse( JSON.stringify( _board ) );
                mx = my = 0;
                init();
              }
            }catch( e ){
              console.log( e );
            }
          }
        }
      });
    }else{
      init();
    }
  }else{
    init();
  }
});

function init(){
  //. キー入力
  document.body.onkeydown = function( e ){
    var keys = {
      13: 'enter',
      32: 'space',
      37: 'left',
      38: 'up',
      39: 'right',
      40: 'down'
    };

    if( typeof keys[e.keyCode] != 'undefined' ){
      if( e.shiftKey && 37 <= e.keyCode && e.keyCode <= 40 ){
        shiftKeyPress( keys[e.keyCode] );
      }else{
        keyPress( keys[e.keyCode] );
        displayBoard();
      }
    }
  };
}

function shiftKeyPress( key ){
  switch( key ){
  case 'left':
    if( W > 4 ){
      W --;
      init_board();
    }
    break;
  case 'right':
    if( W < 20 ){
      W ++
      init_board();
    }
    break;
  case 'up':
    if( H > 4 ){
      H --;
      init_board();
    }
    break;
  case 'down':
    if( H < 20 ){
      H ++;
      init_board();
    }
    break;
  }
}

function keyPress( key ){
  switch( key ){
  case 'space':
    board[my][mx] = ( board[my][mx] + 1 ) % 6;
    break;
  case 'left':
    if( canGo( mx-1, my ) ){
      go( mx-1, my );
    }
    break;
  case 'right':
    if( canGo( mx+1, my ) ){
      go( mx+1, my );
    }
    break;
  case 'up':
    if( canGo( mx, my-1 ) ){
      go( mx, my-1 );
    }
    break;
  case 'down':
    if( canGo( mx, my+1 ) ){
      go( mx, my+1 );
    }
    break;
  }
}

function canGo( nx, ny ){
  return ( 0 <= nx && nx < W && 0 <= ny && ny < H );
}

function go( nx, ny ){
  mx = nx;
  my = ny;
}

function init_board(){
  /*
  board = [
    [ 0, 0, 0, 1 ],
    [ 2, 0, 0, 2 ],
    [ 2, 0, 0, 2 ],
    [ 2, 5, 5, 2 ]
  ];
  */
  board = [];
  for( var i = 0; i < H; i ++ ){
    var row = [];
    if( i == 0 ){
      for( var j = 0; j < W - 1; j ++ ){
        row.push( 0 );
      }
      row.push( 1 );
    }else if( i == H - 1 ){
      row.push( 2 );
      for( var j = 1; j < W - 1; j ++ ){
        row.push( 5 );
      }
      row.push( 2 );
    }else{
      row.push( 2 );
      for( var j = 1; j < W - 1; j ++ ){
        row.push( 0 );
      }
      row.push( 2 );
    }

    board.push( row );
  }

  mx = 0;
  my = 0;
  displayBoard();
}

function resized(){
  var browserWidth = window.innerWidth;
  var browserHeight = window.innerHeight;
  var canvas = document.getElementById( 'mycanvas' );
  if( canvas && canvas.getContext ){
    canvas.width = browserWidth * 0.8;
    canvas.height = browserHeight * 0.6;
  }

  displayBoard();
}

function displayBoard(){
  //. 画面描画準備
  var canvas = document.getElementById( 'mycanvas' );
  if( !canvas || !canvas.getContext ){
    return false;
  }
  var ctx = canvas.getContext( '2d' );

  //. ボードサイズと、各コマのサイズを確認
  var board_height = H; //board.length;
  var board_width = W; //board[0].length;

  //. 全体をベタ塗り
  ctx.beginPath();
  ctx.fillStyle = "rgb(0,0,0)"; //"rgb( 255, 255, 255 )";
  ctx.fillRect( 0, 0, canvas.width, canvas.height );
  ctx.stroke();

  //. 各ピースを描画
  var w = canvas.width / board_width;
  var h = canvas.height / board_height;
  for( var i = 0; i < board_height; i ++ ){
    var y = h * i;
    for( var j = 0; j < board_width; j ++ ){
      var x = w * j;
      drawPiece( ctx, board[i][j], x, y, w, h );
    }
  }

  //. プロンプトを描画
  drawPrompt( ctx, mx * w, my * h, w, h );

  //. モールを描画
  //drawMole( ctx, 0, 0, w, h );
}

function drawPiece( ctx, piece, x, y, w, h ){
  if( piece >= 0 ){
    //. 0 だとサイズもゼロ？
    //if( piece == 0 && y == 0 ){ alert( 'piece == y == 0 ' ); }
    ctx.drawImage( imgs[piece], 0, 0, imgs[piece].width, imgs[piece].height, x, y, w, h );
  }
}

function drawMole( ctx, x, y, w, h ){
  ctx.drawImage( imgs[6], 0, 0, imgs[6].width, imgs[6].height, x, y, w, h );
}

function drawPrompt( ctx, x, y, w, h ){
  ctx.strokeStyle = "rgb(255,255,255)";
  ctx.strokeRect( x, y, w, h );
}

function play(){
  if( confirm( 'Play this stage?' ) ){
    var param = JSON.stringify( board ).split( ' ' ).join( '' );
    location.href = './?board=' + param;
  }
}

function debug(){
  console.log( 'stage = ' + stage + ', cnt = ' + cnt + ', step = ' + step );
  console.log( 'mx = ' + mx + ', my = ' + my );
  console.log( board );
}
</script>
</head>
<body>

<nav class="navbar navbar-light bg-light">
  <a class="navbar-brand" href="#">molemole</a>
  <ul class="navbar-nav mr-auto"></ul>
  <ul class="navbar-nav" id="navbar">
    <li id="sec">
    </li>
  </ul>
</nav>

<div id="canvas_div">
  <div id="cdiv">
    <canvas width="80%" height="50%" id="mycanvas"></canvas>
  </div>
</div>

<button class="btn btn-warning" onClick="play();">play</button>
<!--
<button class="btn btn-success" onClick="debug();">debug</button>
-->

</body>
</html>
